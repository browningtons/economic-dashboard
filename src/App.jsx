import React, { useState, useEffect, useMemo } from 'react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, 
  ReferenceArea, ComposedChart, ScatterChart, Scatter, ZAxis, AreaChart, Area
} from 'recharts';
import { 
  Upload, Info, ExternalLink, Activity, CheckSquare, Square, TrendingUp, 
  BarChart2, ArrowRightLeft, Minus, Calculator, ScatterPlot, Home, Briefcase, 
  AlertTriangle, Frown, DollarSign, TrendingDown
} from 'lucide-react';

// --- Configuration & Metadata ---
const INDICATOR_CONFIG = {
  unemployment_rate: {
    label: "Unemployment Rate",
    definition: "The unemployment rate represents the number of unemployed as a percentage of the labor force.",
    source: "https://fred.stlouisfed.org/series/UNRATE",
    color: "#8884d8", // Purple
    unit: "%",
    dataKey: "unemployment_rate"
  },
  "S&P 500": {
    label: "S&P 500 Index",
    definition: "The Standard & Poor's 500 Index is a market-capitalization-weighted index of 500 leading publicly traded companies in the U.S.",
    source: "https://fred.stlouisfed.org/series/SP500",
    color: "#2ca02c", // Green
    unit: "",
    dataKey: "S&P 500"
  },
  job_openings: {
    label: "Job Openings",
    definition: "Total Nonfarm Job Openings are a measure of all jobs that are not filled on the last business day of the month.",
    source: "https://fred.stlouisfed.org/series/JTSJOL",
    color: "#ffc658", // Orange
    unit: "",
    dataKey: "job_openings"
  },
  fed_rate: {
    label: "Fed Rate",
    definition: "The federal funds rate is the interest rate at which depository institutions trade federal funds with each other overnight.",
    source: "https://fred.stlouisfed.org/series/FEDFUNDS",
    color: "#EA4228", // Red
    unit: "%",
    dataKey: "fed_rate"
  },
  "30 year mortgage": {
    label: "30-Year Mortgage Rate",
    definition: "Contract interest rate on commitments for fixed-rate first mortgages.",
    source: "https://fred.stlouisfed.org/series/MORTGAGE30US",
    color: "#d62728", // Brick Red
    unit: "%",
    dataKey: "30 year mortgage"
  },
  "Housing Price Index": {
    label: "Housing Price Index",
    definition: "A broad measure of the movement of single-family house prices in the United States.",
    source: "https://fred.stlouisfed.org/series/USSTHPI",
    color: "#8d6e63", // Brown
    unit: "",
    dataKey: "Housing Price Index"
  },
  CPI: {
    label: "CPI (Inflation)",
    definition: "The Consumer Price Index measures the average change over time in the prices paid by urban consumers for a market basket of consumer goods and services.",
    source: "https://fred.stlouisfed.org/series/CPIAUCSL",
    color: "#db2777", // Pink
    unit: "",
    dataKey: "CPI"
  },
  avg_weeks_unemployed: {
    label: "Avg Weeks Unemployed",
    definition: "The average number of weeks people have been unemployed.",
    source: "https://fred.stlouisfed.org/series/UEMPMEAN",
    color: "#82ca9d", // Light Green
    unit: " wks",
    dataKey: "avg_weeks_unemployed"
  },
  unemployed_count: {
    label: "Unemployed Count",
    definition: "The aggregate measure of people currently unemployed in the US.",
    source: "https://fred.stlouisfed.org/series/UNEMPLOY",
    color: "#0088FE", // Blue
    unit: " ppl",
    dataKey: "unemployed_count"
  },
};

// --- Economic Events (Recessions & AI) ---
const REFERENCE_ZONES = [
  { label: "Dot Com", start: "2001-03-01", end: "2001-11-01", color: "#e5e7eb", opacity: 0.5, labelPos: 'insideTopLeft' },
  { label: "Great Recession", start: "2007-12-01", end: "2009-06-01", color: "#e5e7eb", opacity: 0.5, labelPos: 'insideTopLeft' },
  { label: "COVID-19", start: "2020-02-01", end: "2020-04-01", color: "#e5e7eb", opacity: 0.8, labelPos: 'insideTop' },
  { label: "ChatGPT", start: "2022-11-01", end: "2023-01-01", color: "#dbeafe", opacity: 0.6, labelPos: 'insideBottom' } 
];

// --- UPDATED Data from File 5 (Fixed Column Shift in Last Row) ---
const INITIAL_CSV_DATA = `observation_date,unemployment_rate,avg_weeks_unemployed,median_weeks_unemployed,job_openings,unemployed_27_weeks,unemployed_count,fed_rate,15 year mortgage,30 year mortgage,S&P 500,Labor Participation Rate,Labor Participation Core,Housing Price Index,CPI
1/1/00,4,13.1,5.8,,721,,5.45,7.8025,8.21,1425.6,67.3,84.4,100,181.1
2/1/00,4.1,12.6,6.1,,629,,5.73,7.9325,8.325,1388.9,67.3,84.4,100.571,181.5
3/1/00,4,12.7,6,,646,,5.85,7.832,8.24,1442.2,67.3,84.3,101.466,182
4/1/00,3.8,12.4,6.1,,599,,6.02,7.8,8.153,1461.4,67.3,84.4,102.54,182.3
5/1/00,4,12.6,5.8,,643,,6.27,8.1825,8.515,1418.5,67.1,84.1,103.701,182.7
6/1/00,4,12.3,5.7,,627,,6.53,7.992,8.288,1462,67.1,84.1,104.856,183.2
7/1/00,4,13.4,6,,698,,6.54,7.865,8.1475,1473,66.9,83.9,105.723,183.9
8/1/00,4.1,12.9,6.3,,709,,6.5,7.7625,8.0275,1485.5,66.9,83.8,106.523,184.6
9/1/00,3.9,12.2,5.2,,646,,6.52,7.604,7.912,1468.1,66.9,83.7,107.137,185.3
10/1/00,3.9,12.7,6.1,,627,,6.51,7.47,7.795,1390.1,66.8,83.6,107.729,186.1
11/1/00,3.9,12.4,6.1,,593,,6.51,7.4175,7.745,1378,66.9,83.8,108.292,186.8
12/1/00,3.9,12.5,6,5088,642,,6.4,7.056,7.382,1330.9,67,83.9,108.792,187.6
1/1/01,4.2,12.7,5.8,5234,676,,5.98,6.64,7.0325,1335.6,67.2,84.1,109.216,188.2
2/1/01,4.2,12.8,6.1,5097,714,,5.49,6.64,7.05,1305.8,67.1,84.1,109.643,188.9
3/1/01,4.3,12.8,6.6,4762,696,,5.31,6.508,6.952,1185.9,67.2,84.1,110.395,189.6
4/1/01,4.4,12.4,5.9,4615,712,,4.8,6.595,7.0775,1189.8,66.9,83.7,111.247,190.2
5/1/01,4.3,12.1,6.3,4425,624,,4.21,6.675,7.145,1270.4,66.7,83.8,112.202,191
6/1/01,4.5,12.7,6,4361,710,,3.97,6.7,7.16,1238.7,66.7,83.6,113.273,191.6
7/1/01,4.6,12.9,6.8,4447,702,,3.77,6.6825,7.1275,1204.5,66.8,83.6,114.228,192.3
8/1/01,4.9,13.3,6.9,4024,857,,3.65,6.5,6.95,1178.5,66.5,83.5,114.989,193.1
9/1/01,5,13.2,7.2,4071,819,,3.07,6.34,6.8175,1044.6,66.8,83.5,115.466,193.9
10/1/01,5.3,13.3,7.3,3707,909,,2.49,6.0975,6.6175,1076.6,66.7,83.6,115.681,194.7
11/1/01,5.5,14.3,7.7,3775,1106,,2.09,6.146,6.658,1129.7,66.7,83.5,115.837,195.5
12/1/01,5.7,14.5,8.2,3677,1126,,1.82,6.5425,7.065,1144.9,66.7,83.7,116.054,196.4
1/1/02,5.7,14.7,8.4,3699,1203,,1.73,6.48,6.9975,1140.2,66.5,83.5,116.436,197
2/1/02,5.7,15,8.3,3436,1214,,1.74,6.375,6.8925,1100.7,66.8,83.7,116.917,197.7
3/1/02,5.7,15.4,8.4,3612,1330,,1.73,6.516,7.014,1153.8,66.6,83.5,117.93,198.2
4/1/02,5.9,16.3,8.9,3471,1457,,1.75,6.475,6.985,1111.9,66.7,83.6,119.21,198.5
5/1/02,5.8,16.8,9.5,3457,1574,,1.75,6.28,6.806,1079.3,66.7,83.6,120.789,198.8
6/1/02,5.8,16.9,11,3412,1641,,1.75,6.105,6.65,1014,66.6,83.2,122.334,199.3
7/1/02,5.8,16.9,8.9,3367,1584,,1.73,5.93,6.485,903.59,66.5,83.1,123.688,199.8
8/1/02,5.7,16.5,9,3517,1573,,1.74,5.702,6.29,912.55,66.6,83.2,124.731,200.2
9/1/02,5.7,17.6,9.5,3301,1580,,1.75,5.5075,6.0925,867.81,66.7,83.3,125.495,200.7
10/1/02,5.7,17.8,9.6,3479,1653,,1.75,5.5,6.1125,854.63,66.6,83.2,126.138,201.3
11/1/02,5.9,17.6,9.3,3514,1743,,1.34,5.464,6.068,909.93,66.4,82.9,126.644,202
12/1/02,6,18.5,9.6,3169,1924,,1.24,5.45,6.0475,899.18,66.3,83.1,127.152,202.5
1/1/03,5.8,18.5,9.6,3441,1760,,1.24,5.304,5.916,895.84,66.4,82.9,127.653,203.3
2/1/03,5.9,18.5,9.5,3229,1864,,1.26,5.22,5.8425,837.03,66.4,83,128.327,203.7
3/1/03,5.9,18.1,9.7,3099,1798,,1.25,5.065,5.745,846.63,66.3,83.1,129.308,204.1
4/1/03,6,19.4,10.2,3108,1927,,1.26,5.1175,5.8125,890.03,66.4,83.2,130.488,204.5
5/1/03,6.1,19,9.9,3289,1929,,1.26,4.86,5.484,935.96,66.4,83.1,131.84,204.9
6/1/03,6.3,19.9,11.5,3390,2100,,1.22,4.6275,5.23,988,66.5,83.3,133.226,205.1
7/1/03,6.2,19.7,10.3,2981,1972,,1.01,4.9675,5.6325,992.54,66.2,83,134.648,205.6
8/1/03,6.1,19.2,10.1,3190,1995,8896,1.03,5.588,6.264,989.53,66.1,83,135.966,206.1
9/1/03,6.1,19.5,10.2,3091,2014,8921,1.01,5.4575,6.1475,1019.4,66.1,82.8,137.077,206.6
10/1/03,6,19.3,10.4,3305,1959,8732,1.01,5.274,5.952,1038.7,66.1,82.9,137.977,206.9
11/1/03,5.8,19.9,10.3,3324,2006,8576,1,5.2725,5.9325,1049.9,66.1,82.8,138.766,207.5
12/1/03,5.7,19.8,10.4,3414,1931,8317,0.98,5.204,5.876,1080.6,65.9,82.8,139.629,207.9
1/1/04,5.7,19.9,10.6,3424,1911,8370,1,5.015,5.7125,1132.5,66.1,82.8,140.706,208.3
2/1/04,5.6,20.1,10.2,3532,1856,8167,1.01,4.9375,5.635,1143.4,66,82.7,142.029,208.8
3/1/04,5.8,19.8,10.2,3525,1983,8491,1,4.74,5.445,1124,66,82.8,144.08,209.2
4/1/04,5.6,19.6,9.5,3511,1805,8170,1,5.158,5.83,1133.4,65.9,82.7,146.18,209.7
5/1/04,5.6,19.8,9.9,3710,1799,8212,1,5.6375,6.27,1102.8,66,82.8,148.335,210.2
6/1/04,5.6,20.5,11,3337,1847,8286,1.03,5.66,6.2875,1132.8,66.1,82.9,150.52,210.7
7/1/04,5.5,18.8,8.9,3814,1681,8136,1.26,5.464,6.056,1105.9,66.1,83,152.339,211.2
8/1/04,5.4,18.8,9.2,3541,1640,7990,1.43,5.26,5.8675,1088.9,66,82.7,153.815,211.9
9/1/04,5.4,19.4,9.6,3821,1702,7927,1.61,5.144,5.754,1117.7,65.8,82.7,155.108,212.4
10/1/04,5.5,19.5,9.5,3943,1737,8061,1.76,5.115,5.7225,1117.2,65.9,82.6,156.298,212.8
11/1/04,5.4,19.7,9.7,3472,1702,7932,1.93,5.135,5.73,1173.8,66,82.7,157.495,213.2
12/1/04,5.4,19.4,9.5,4074,1653,7934,2.16,5.178,5.752,1213.6,65.9,82.6,158.669,213.9
1/1/05,5.3,19.5,9.4,3804,1648,7784,2.28,5.1725,5.71,1181.3,65.8,82.7,160.13,214.5
2/1/05,5.4,19.1,9.2,3965,1628,7980,2.5,5.15,5.6275,1203.6,65.9,82.8,161.925,215
3/1/05,5.2,19.5,9.3,4044,1660,7737,2.63,5.464,5.928,1180.6,65.9,82.6,164.577,215.5
4/1/05,5.2,19.6,9,4159,1609,7672,2.79,5.4075,5.855,1156.9,66.1,82.7,167.001,216
5/1/05,5.1,18.6,9.1,3797,1538,7651,3,5.28,5.72,1191.5,66.1,82.9,169.546,216.4
6/1/05,5,17.9,9,4062,1375,7524,3.04,5.168,5.582,1191.3,66.1,82.6,172.018,216.8
7/1/05,5,17.6,8.8,4256,1380,7406,3.26,5.2775,5.695,1234.2,66.1,82.8,174.1,217.5
8/1/05,4.9,18.4,9.2,4142,1407,7345,3.5,5.4,5.82,1228.8,66.2,82.9,175.926,218
9/1/05,5,17.9,8.4,4352,1439,7553,3.62,5.358,5.774,1228.8,66.1,82.9,177.613,218.6
10/1/05,5,17.9,8.6,4184,1422,7453,3.78,5.625,6.065,1207,66.1,82.7,178.755,219.3
11/1/05,5,17.5,8.5,4248,1370,7566,4,5.8625,6.33,1249.5,66,82.7,179.676,220
12/1/05,4.9,17.5,8.7,4282,1356,7279,4.16,5.816,6.272,1248.3,66,82.7,180.109,220.5
1/1/06,4.7,16.9,8.6,4397,1170,7064,4.29,5.71,6.145,1280.1,66,82.8,180.828,220.9
2/1/06,4.8,17.8,9.1,4325,1350,7184,4.49,5.86,6.2525,1280.7,66.1,82.9,181.499,221.6
3/1/06,4.7,17.1,8.7,4732,1309,7072,4.59,5.968,6.324,1294.9,66.2,83,182.749,222.3
4/1/06,4.7,16.7,8.4,4790,1331,7120,4.79,6.155,6.5075,1309.9,66.1,82.8,183.648,222.9
5/1/06,4.6,17.1,8.5,4463,1333,6980,4.94,6.205,6.5975,1287.2,66.1,82.8,184.38,223.6
6/1/06,4.6,16.6,7.3,4614,1145,7001,4.99,6.306,6.682,1270.2,66.2,82.8,184.547,224.4
7/1/06,4.7,17.1,8,4394,1304,7175,5.24,6.39,6.7625,1278.6,66.1,83,184.607,225.2
8/1/06,4.7,17.1,8.4,4710,1306,7091,5.25,6.198,6.524,1303.8,66.2,82.9,184.404,226.2
9/1/06,4.5,17.1,8,4737,1245,6847,5.25,6.0775,6.4025,1336.3,66.1,82.9,184.198,227.1
10/1/06,4.4,16.3,7.9,4591,1078,6727,5.25,6.05,6.3575,1377.9,66.2,82.9,184.054,228
11/1/06,4.5,16.2,8.3,4645,1131,6872,5.25,5.956,6.24,1400.6,66.3,83,183.631,228.9
12/1/06,4.4,16.1,7.5,4620,1093,6762,5.24,5.88,6.135,1418.3,66.4,83.1,183.229,230
1/1/07,4.6,16.3,8.3,4763,1141,7116,5.25,5.965,6.2175,1438.2,66.4,83.4,182.718,230.806
2/1/07,4.5,16.7,8.5,4699,1249,6927,5.26,6.02,6.285,1407.3,66.3,83.2,182.47,231.739
3/1/07,4.4,17.8,9.1,4962,1245,6731,5.26,5.884,6.156,1420.9,66.2,83.2,182.192,232.495
4/1/07,4.5,16.9,8.6,4689,1206,6850,5.25,5.8825,6.18,1482.4,65.9,83,182.13,232.98
5/1/07,4.4,16.6,8.2,4657,1132,6766,5.25,5.968,6.262,1515.9,66,83,181.883,233.549
6/1/07,4.6,16.5,7.7,4859,1143,6979,5.25,6.34,6.6575,1503.4,66,82.9,181.539,234.071
7/1/07,4.7,17.2,8.7,4598,1291,7149,5.26,6.36,6.695,1474,66,82.9,180.993,234.732
8/1/07,4.6,17,8.8,4546,1246,7067,5.02,6.234,6.572,1452.1,65.8,82.9,180.235,235.311
9/1/07,4.7,16.3,8.7,4652,1264,7170,4.94,6.0475,6.3825,1486.6,66,82.8,179.122,236.058
10/1/07,4.7,17,8.4,4636,1298,7237,4.76,6.04,6.375,1539.7,65.8,82.7,177.53,237.135
11/1/07,4.7,17.3,8.6,4646,1374,7240,4.49,5.85,6.208,1463.4,66,82.9,175.162,238.169
12/1/07,5,16.6,8.4,4545,1324,7645,4.24,5.7525,6.095,1479.2,66,83.1,173.337,239.102
1/1/08,5,17.5,9,4624,1388,7685,3.94,5.288,5.758,1378.8,66.2,83.3,171.077,239.85
2/1/08,4.9,16.9,8.7,4279,1329,7497,2.98,5.44,5.9175,1354.9,66,83.2,169.19,240.325
3/1/08,5.1,16.5,8.7,4225,1323,7822,2.61,5.42,5.97,1316.9,66.1,83.3,167.901,240.874
4/1/08,5,16.9,9.4,4035,1372,7637,2.28,5.465,5.9175,1370.5,65.9,83.1,167.318,241.474
5/1/08,5.4,16.6,7.9,4194,1561,8395,1.98,5.6,6.036,1403.2,66.1,83.1,167.015,241.803
6/1/08,5.6,17.1,9,3830,1576,8575,2,5.91,6.32,1341.3,66.1,83.1,166.534,242.64
7/1/08,5.8,17,9.7,3749,1664,8937,2.01,5.972,6.426,1257.3,66.1,83.1,165.712,243.367
8/1/08,6.1,17.7,9.7,3674,1866,9438,2,6.025,6.4775,1281.5,66.1,83.2,164.277,244.181
9/1/08,6.1,18.6,10.2,3222,2027,9494,1.81,5.64,6.0375,1217,66,83.1,161.912,244.926
10/1/08,6.5,19.9,10.4,3377,2280,10074,0.97,5.892,6.2,968.8,66,83,159.163,245.855
11/1/08,6.8,18.9,9.8,3231,2219,10538,0.39,5.79,6.0875,883.04,65.9,83,156.071,246.681
12/1/08,7.3,19.9,10.5,3146,2610,11286,0.16,5.038,5.286,877.56,65.8,82.8,152.544,247.278
1/1/09,7.8,19.8,10.7,2738,2699,12058,0.15,4.7175,5.0475,865.58,65.7,82.8,149.361,247.974
2/1/09,8.3,20.2,11.7,2864,2999,12898,0.22,4.7725,5.13,805.23,65.8,82.8,147.616,248.305
3/1/09,8.7,20.9,12.3,2534,3260,13426,0.18,4.6375,5.0025,757.13,65.6,82.6,146.513,248.639
4/1/09,9,21.7,13.1,2295,3752,13853,0.15,4.5,4.81,848.15,65.7,82.8,146.941,248.899
5/1/09,9.4,22.4,14.2,2549,3973,14499,0.18,4.515,4.8575,902.41,65.7,82.9,148.169,249.069
6/1/09,9.5,23.9,17.2,2503,4349,14707,0.21,4.9025,5.42,926.12,65.7,82.9,149.796,249.092
7/1/09,9.5,25.1,16,2232,4917,14601,0.16,4.692,5.222,935.82,65.5,82.8,150.748,248.994
8/1/09,9.6,25.3,16.3,2338,5037,14814,0.16,4.6125,5.1925,1009.73,65.4,82.8,150.668,249.029
9/1/09,9.8,26.6,17.8,2487,5494,15009,0.15,4.4925,5.0575,1044.55,65.1,82.5,149.626,248.965
10/1/09,10,27.5,18.9,2406,5643,15352,0.12,4.39,4.952,1067.66,65,82.5,148.583,248.888
11/1/09,9.9,28.9,19.8,2503,5908,15219,0.12,4.3425,4.875,1088.07,65,82.4,147.938,248.886
12/1/09,9.9,29.7,20.1,2568,6122,15098,0.12,4.392,4.93,1110.38,64.6,82,146.666,248.999
1/1/10,9.8,30.3,20,2837,6319,15046,0.11,4.435,5.03,1123.58,64.8,82.4,145.003,249.144
2/1/10,9.8,29.8,19.9,2666,6129,15113,0.13,4.3675,4.99,1089.16,64.9,82.3,143.056,249.017
3/1/10,9.9,31.6,20.4,2679,6545,15202,0.16,4.33,4.9675,1152.05,64.9,82.4,143.596,249.089
4/1/10,9.9,33.3,22.1,3153,6800,15325,0.2,4.418,5.098,1197.32,65.2,82.6,145.397,249.012
5/1/10,9.6,34,22.3,2988,6638,14849,0.2,4.2775,4.8875,1125.06,64.9,82.3,147.03,248.925
6/1/10,9.4,34.5,25.2,2801,6623,14474,0.18,4.175,4.7375,1083.36,64.6,82.2,147.697,248.999
7/1/10,9.4,33.9,22.3,3082,6506,14512,0.18,4.04,4.564,1079.8,64.6,81.9,147.558,249.126
8/1/10,9.5,33.7,21,2999,6259,14648,0.19,3.9075,4.4275,1087.28,64.7,82,146.424,249.024
9/1/10,9.5,33.4,20.3,2918,6163,14579,0.19,3.81,4.346,1122.08,64.6,82,144.605,249.368
10/1/10,9.4,34,21.2,3235,6227,14516,0.19,3.66,4.225,1171.58,64.4,81.8,143.124,249.618
11/1/10,9.8,33.9,21,3211,6326,15081,0.19,3.6825,4.3,1198.89,64.6,82,141.812,250.317
12/1/10,9.3,34.7,21.9,3058,6429,14348,0.18,4.058,4.714,1241.53,64.3,81.9,140.621,250.986
1/1/11,9.1,37.2,21.5,3104,6175,14013,0.17,4.0875,4.755,1304.49,64.2,81.7,139.029,251.555
2/1/11,9,37.4,21.1,3226,5892,13820,0.16,4.215,4.9525,1321.12,64.1,81.6,137.724,251.829
3/1/11,9,39.1,21.5,3261,6105,13737,0.14,4.08,4.836,1304.49,64.2,81.7,137.779,252.145
4/1/11,9.1,38.7,20.9,3259,5925,13957,0.1,4.055,4.84,1331.51,64.2,81.7,139.153,252.221
5/1/11,9,39.6,21.6,3179,6153,13855,0.09,3.8225,4.6375,1338.31,64.1,81.7,140.688,252.393
6/1/11,9.1,39.9,22.4,3455,6271,13962,0.09,3.694,4.51,1287.29,64,81.7,141.94,252.592
7/1/11,9,40.7,22,3623,6195,13763,0.07,3.68,4.545,1325.19,64,81.4,142.339,253.085
8/1/11,9,40.5,22.4,3329,6048,13818,0.1,3.46,4.27,1185.31,64.1,81.6,141.781,254.003
9/1/11,9,40.4,22,3774,6304,13948,0.08,3.318,4.106,1173.88,64.2,81.5,140.161,254.628
10/1/11,8.8,38.7,20.6,3619,5838,13594,0.07,3.3475,4.0675,1207.22,64.1,81.3,138.398,255.651
11/1/11,8.6,40.2,20.8,3565,5698,13302,0.08,3.305,3.9925,1226.42,64.1,81.5,136.653,256.367
12/1/11,8.5,40.4,20.5,3768,5586,13093,0.07,3.246,3.958,1243.32,64,81.6,135.155,257.189
1/1/12,8.3,40.2,20.8,3909,5476,12797,0.08,3.2,3.915,1300.58,63.7,81.5,134.157,257.714
2/1/12,8.3,39.7,19.7,3616,5242,12813,0.1,3.1625,3.89,1352.49,63.8,81.5,133.987,258.184
3/1/12,8.2,39.3,19.2,3979,5236,12713,0.13,3.198,3.954,1389.24,63.8,81.5,135.856,258.569
4/1/12,8.2,39.2,19.1,3793,5132,12646,0.14,3.1425,3.91,1386.43,63.7,81.4,138.461,258.922
5/1/12,8.2,39.6,19.9,3835,5401,12660,0.16,3.034,3.798,1341.27,63.7,81.4,141.037,259.231
6/1/12,8.2,40.3,20.4,3911,5409,12692,0.16,2.9525,3.675,1323.48,63.8,81.5,143.158,259.407
7/1/12,8.2,39.3,17.5,3735,5210,12656,0.16,2.845,3.55,1359.78,63.7,81.4,144.272,260.107
8/1/12,8.1,39.6,18.4,3809,5042,12471,0.13,2.86,3.602,1403.45,63.5,81.4,144.695,260.677
9/1/12,7.8,39.8,18.8,3882,4911,12115,0.14,2.8025,3.4975,1443.42,63.6,81.5,144.347,261.421
10/1/12,7.8,39.6,19.9,3775,4988,12124,0.16,2.6925,3.3825,1437.82,63.8,81.6,143.956,262.707
11/1/12,7.7,39,18.6,3878,4805,12005,0.16,2.662,3.352,1394.51,63.6,81.2,143.949,263.365
12/1/12,7.9,37.6,17.7,3970,4768,12298,0.16,2.6575,3.345,1422.29,63.7,81.4,143.856,264.098
1/1/13,8,35.6,15.8,3923,4681,12471,0.14,2.696,3.414,1480.4,63.7,81.1,144.301,264.7
2/1/13,7.7,36.4,17.2,4004,4691,11950,0.15,2.7675,3.5325,1512.31,63.4,81,145.153,265.256
3/1/13,7.5,37,17.6,4076,4563,11689,0.14,2.7575,3.565,1550.83,63.3,81,147.953,265.821
4/1/13,7.6,36.5,17.1,3988,4468,11760,0.15,2.66,3.445,1570.7,63.4,81,150.963,265.984
5/1/13,7.5,36.8,17.1,4145,4347,11654,0.11,2.722,3.536,1639.84,63.4,81.2,153.852,266.559
6/1/13,7.5,36.4,17,4150,4355,11751,0.09,3.1675,4.07,1618.77,63.4,81.2,156.418,266.905
7/1/13,7.3,37.3,16.2,3885,4258,11335,0.09,3.43,4.37,1668.68,63.3,81.2,158.276,267.482
8/1/13,7.2,37.6,16.5,4085,4296,11279,0.08,3.488,4.456,1670.09,63.3,81,159.382,268.505
9/1/13,7.2,37.4,16.5,4128,4132,11270,0.08,3.5225,4.49,1687.17,63.2,81,159.662,269.137
10/1/13,7.2,35.1,16.3,4222,4024,11136,0.09,3.274,4.192,1720.03,62.8,80.6,159.549,269.96
11/1/13,6.9,36.6,17.1,4119,4042,10787,0.08,3.2975,4.255,1783.54,63,81,159.361,270.698
12/1/13,6.7,36.5,17.3,4121,3863,10404,0.09,3.4825,4.4575,1807.78,62.9,80.8,159.278,271.688
1/1/14,6.6,35.1,15.4,4127,3607,10202,0.07,3.48,4.432,1822.36,62.9,80.9,159.365,272.317
2/1/14,6.7,36.5,15.9,4373,3783,10349,0.07,3.35,4.3025,1817.04,62.9,81.1,159.866,272.733
3/1/14,6.7,35.3,15.8,4388,3704,10380,0.08,3.36,4.3425,1863.52,63.1,81.1,161.179,273.486
4/1/14,6.2,34.9,15.7,4566,3479,9702,0.09,3.3925,4.3375,1864.26,62.8,80.8,162.955,274.1
5/1/14,6.3,34.4,14.6,4747,3360,9859,0.09,3.29,4.192,1889.77,62.9,80.7,164.668,274.71
6/1/14,6.1,33.9,13.8,4982,3116,9460,0.1,3.265,4.1625,1947.09,62.8,81,166.197,275.321
7/1/14,6.2,32.7,13.1,4846,3136,9608,0.09,3.236,4.13,1973.1,62.9,80.8,167.121,276.248
8/1/14,6.1,32,12.9,5349,2958,9599,0.09,3.2475,4.115,1961.53,62.9,81.1,167.436,277.048
9/1/14,5.9,31.9,13.4,4914,2948,9262,0.09,3.3075,4.1625,1993.23,62.8,80.8,167.228,277.998
10/1/14,5.7,32.3,13.6,5012,2892,8990,0.09,3.21,4.036,1937.27,62.9,80.9,166.897,278.985
11/1/14,5.8,32.7,13,4843,2828,9090,0.09,3.1875,3.9975,2044.57,62.9,80.9,166.645,280.123
12/1/14,5.6,32.7,12.9,5130,2799,8717,0.12,3.128,3.864,2054.27,62.8,80.9,166.446,280.874
1/1/15,5.7,32,13.2,5344,2774,8885,0.11,2.985,3.67,2028.18,62.9,81,166.233,281.572
2/1/15,5.5,31.2,12.9,5466,2658,8599,0.11,3.0075,3.71,2082.2,62.7,80.9,166.612,282.389
3/1/15,5.4,30.5,12,5210,2542,8515,0.11,3.04,3.77,2079.99,62.6,80.8,168.071,283.13
4/1/15,5.4,30.9,11.5,5598,2560,8550,0.12,2.942,3.672,2094.86,62.8,81,169.957,283.598
5/1/15,5.6,30.7,11.6,5563,2503,8834,0.12,3.0625,3.84,2111.94,62.9,81.1,171.838,284.245
6/1/15,5.3,28.4,11.8,5248,2162,8247,0.13,3.1925,3.9825,2099.29,62.7,80.9,173.436,285.031
7/1/15,5.2,28.1,10.9,6056,2127,8167,0.13,3.214,4.046,2094.14,62.6,80.7,174.479,286.09
8/1/15,5.1,28.4,11.7,5467,2172,7992,0.14,3.1275,3.905,2039.87,62.6,80.7,174.918,287.068
9/1/15,5,25.7,11.3,5488,2097,7907,0.14,3.095,3.89,1944.41,62.4,80.6,175.023,288.306
10/1/15,5,27.5,11.3,5773,2130,7922,0.12,3.01,3.796,2024.81,62.5,80.8,175.027,289.428
11/1/15,5.1,27.9,11,5708,2074,8000,0.12,3.1625,3.9425,2080.62,62.5,80.9,175.116,290.322
12/1/15,5,27.9,11,5845,2127,7907,0.24,3.206,3.964,2054.08,62.7,80.9,175.089,291.204
1/1/16,4.8,29.1,11.3,6012,2081,7627,0.34,3.155,3.8725,1918.6,62.7,81.1,175.013,292.004
2/1/16,4.9,29.4,11.3,5770,2150,7702,0.38,2.96,3.66,1904.42,62.8,81.1,175.261,292.777
3/1/16,5,28.3,11.3,6129,2231,7961,0.36,2.966,3.694,2021.95,63,81.3,176.584,293.489
4/1/16,5.1,27.9,11.1,5803,2147,8067,0.37,2.87,3.605,2075.54,62.9,81.2,178.48,294.175
5/1/16,4.8,26.9,10.7,5777,1925,7652,0.37,2.8425,3.6,2065.55,62.7,81.2,180.329,295.036
6/1/16,4.9,28,10.8,5742,1986,7744,0.38,2.842,3.568,2083.89,62.7,81.3,181.901,295.902
7/1/16,4.8,27.8,11.1,5962,1943,7641,0.39,2.7475,3.44,2148.9,62.8,81.3,183.003,296.862
8/1/16,4.9,27.2,10.7,5677,1970,7784,0.4,2.745,3.435,2170.95,62.9,81.4,183.641,297.916
9/1/16,5,26.5,10.2,5868,1933,7953,0.4,2.756,3.46,2157.69,62.9,81.5,183.928,298.962
10/1/16,4.9,26.6,10.1,5591,1946,7811,0.4,2.7625,3.47,2143.02,62.8,81.5,183.997,300.4
11/1/16,4.7,25.9,10.3,5971,1865,7553,0.41,3.0275,3.77,2164.99,62.7,81.4,184.206,301.587
12/1/16,4.7,26.3,10.6,5964,1860,7521,0.54,3.428,4.198,2246.63,62.7,81.3,184.379,302.735
1/1/17,4.7,25.3,10.3,5617,1866,7468,0.65,3.3875,4.15,2275.12,62.8,81.5,184.633,303.467
2/1/17,4.6,25.5,10.1,5923,1803,7379,0.66,3.38,4.1675,2329.91,62.9,81.6,185.001,304.211
3/1/17,4.4,25.1,10.3,5811,1677,7073,0.79,3.414,4.196,2366.82,62.9,81.6,186.51,304.868
4/1/17,4.4,24.1,9.9,6091,1709,7089,0.9,3.3,4.045,2359.31,63,81.7,188.524,305.477
5/1/17,4.4,24.7,10.5,5826,1721,7000,0.91,3.255,4.01,2395.35,62.8,81.7,190.519,306.379
6/1/17,4.3,24.6,10,6305,1654,6873,1.04,3.174,3.904,2433.99,62.8,81.6,192.243,307.314
7/1/17,4.3,24.6,10.2,6238,1720,6892,1.15,3.235,3.9675,2454.1,62.9,81.8,193.487,308.173
8/1/17,4.4,24,10.3,6276,1687,7082,1.16,3.16,3.88,2456.22,62.9,81.6,194.32,309.479
9/1/17,4.3,26.1,10.1,6320,1683,6854,1.15,3.105,3.805,2492.84,63.1,81.9,194.79,310.268
10/1/17,4.2,26.2,9.7,6408,1609,6700,1.15,3.2,3.895,2557,62.7,81.6,195.055,311.501
11/1/17,4.2,25.7,9.8,6271,1589,6774,1.16,3.288,3.922,2593.61,62.7,81.7,195.419,312.67
12/1/17,4.1,24.2,9.3,6336,1516,6632,1.3,3.385,3.95,2664.34,62.7,81.8,195.816,313.904
1/1/18,4,24.2,9.7,6621,1467,6489,1.41,3.4825,4.0325,2789.8,62.7,81.7,196.088,314.788
2/1/18,4.1,22.9,9.2,6552,1432,6581,1.42,3.785,4.33,2705.16,63,82.1,196.879,315.277
3/1/18,4,24,8.8,6818,1345,6472,1.51,3.91,4.444,2702.77,62.9,82,198.545,315.883
4/1/18,4,22.5,9.6,6877,1375,6459,1.69,3.925,4.4675,2653.63,62.9,82,200.584,316.763
5/1/18,3.8,21.1,9.2,7016,1233,6196,1.7,4.066,4.586,2701.49,62.9,81.9,202.42,317.49
6/1/18,4,20.8,9,7230,1404,6447,1.82,4.04,4.57,2754.35,63,82.1,204.013,318.318
7/1/18,3.8,23.1,9.8,7190,1416,6195,1.91,4.0075,4.5275,2793.64,63,82.1,204.922,319.351
8/1/18,3.8,22.4,9.3,7208,1287,6156,1.91,4.018,4.55,2857.82,62.6,81.9,205.301,320.651
9/1/18,3.7,24.2,9.2,7411,1351,6073,1.95,4.08,4.6275,2901.5,62.8,81.9,205.347,321.533
10/1/18,3.8,23.1,9.4,7304,1348,6211,2.19,4.2475,4.83,2785.46,62.9,82.3,205.342,322.628
11/1/18,3.8,22.1,8.9,7594,1228,6115,2.2,4.282,4.866,2723.23,62.9,82.2,205.079,323.968
12/1/18,3.9,21.9,9.6,7489,1306,6389,2.27,4.09,4.6375,2567.31,63,82.3,204.669,324.815
1/1/19,4,20.5,9.5,7502,1287,6475,2.4,3.906,4.464,2607.39,63.1,82.5,204.17,325.597
2/1/19,3.8,21.8,9.6,7066,1283,6136,2.4,3.8,4.37,2754.86,63.1,82.5,204.395,326.351
3/1/19,3.8,22.2,9.6,7317,1264,6202,2.41,3.7175,4.265,2803.98,63,82.4,205.743,327.513
4/1/19,3.7,22.5,9.2,7272,1230,5961,2.42,3.605,4.1425,2903.8,62.8,82.2,207.658,328.678
5/1/19,3.6,24,9.2,7275,1299,5930,2.39,3.534,4.072,2854.71,62.9,82.2,209.321,329.333
6/1/19,3.6,21.6,9.6,7194,1333,5935,2.38,3.2375,3.8025,2890.17,63,82.2,210.555,330.648
7/1/19,3.7,19.6,8.9,7042,1227,6061,2.4,3.2025,3.765,2996.11,63.1,82.1,211.304,331.605
8/1/19,3.6,21.9,8.7,7178,1257,5945,2.13,3.082,3.616,2897.5,63.1,82.5,211.662,332.638
9/1/19,3.5,22.5,9.2,7124,1338,5753,2.04,3.115,3.605,2982.16,63.2,82.7,211.842,333.834
10/1/19,3.6,22.4,9,7289,1291,5871,1.83,3.142,3.688,2977.68,63.3,82.8,211.937,334.68
11/1/19,3.6,20.3,8.9,6888,1208,5868,1.55,3.1575,3.695,3104.9,63.3,82.9,212.078,335.819
12/1/19,3.6,20.7,9.1,6699,1188,5853,1.55,3.1775,3.72,3176.75,63.3,83,212.21,336.789
1/1/20,3.6,21.9,10,7124,1176,5869,1.55,3.072,3.624,3278.2,63.3,83.1,212.368,337.825
2/1/20,3.5,20.6,9.4,6966,1110,5753,1.58,2.97,3.465,3277.31,63.3,82.9,213.187,338.616
3/1/20,4.4,17,6,5894,1140,7206,0.65,2.885,3.45,2652.39,62.6,82.4,215.163,339.519
4/1/20,14.8,7.2,2.2,4606,910,23084,0.05,2.804,3.306,2761.98,60.1,79.8,217.208,340.135
5/1/20,13.2,10.5,7.7,5612,1147,20929,0.05,2.6925,3.2325,2919.61,60.8,80.6,218.456,340.811
6/1/20,11,14.4,13.4,6129,1355,17652,0.08,2.6025,3.1625,3104.66,61.5,81.4,219.782,341.294
7/1/20,10.2,17,14.7,6530,1544,16352,0.09,2.52,3.016,3207.62,61.5,81.2,221.537,341.95
8/1/20,8.4,19.9,16.2,6429,1632,13461,0.1,2.475,2.935,3391.71,61.7,81.3,224.016,342.444
9/1/20,7.8,21.5,17.5,6511,2445,12554,0.09,2.385,2.89,3365.52,61.4,80.9,226.767,342.91
10/1/20,6.9,22,19,6798,3591,11072,0.09,2.346,2.834,3418.7,61.7,81.3,229.776,343.615
11/1/20,6.7,23.3,18.3,6820,3924,10694,0.09,2.305,2.765,3548.99,61.5,81,232.279,344.039
12/1/20,6.7,23.2,16.8,6773,3967,10770,0.09,2.218,2.684,3695.31,61.5,81.1,234.328,344.455
1/1/21,6.4,25.9,16.1,7204,4032,10236,0.09,2.2,2.735,3793.75,61.4,81.1,236.4,344.758
2/1/21,6.2,27.5,18.4,7752,4143,9995,0.08,2.2375,2.81,3883.43,61.4,81.1,239.18,345.242
3/1/21,6.1,29.6,20.3,8470,4171,9756,0.07,2.3925,3.0825,3910.51,61.5,81.3,244.178,345.717
4/1/21,6.1,28.4,20.3,9356,4082,9762,0.07,2.364,3.06,4141.18,61.6,81.3,249.787,346.267
5/1/21,5.8,29.6,19.5,9905,3707,9266,0.06,2.28,2.9625,4167.85,61.6,81.3,255.412,347.016
6/1/21,5.9,32,19.8,10298,3988,9462,0.08,2.27,2.975,4238.49,61.7,81.6,261.132,347.833
7/1/21,5.4,29.8,14.7,11049,3477,8731,0.1,2.18,2.868,4363.71,61.8,81.8,265.463,348.469
8/1/21,5.1,29.5,14.2,10956,3189,8276,0.09,2.145,2.8425,4454.21,61.7,81.7,268.733,349.71
9/1/21,4.7,28.5,13.2,10879,2714,7652,0.08,2.184,2.9,4445.54,61.7,81.6,271.381,351.255
10/1/21,4.5,26.8,12.4,11341,2371,7279,0.08,2.3075,3.0675,4460.71,61.8,81.8,273.587,352.892
11/1/21,4.2,28.9,12.3,11119,2181,6751,0.08,2.3575,3.0675,4667.39,61.9,82,275.954,354.526
12/1/21,3.9,28,11.5,11417,1993,6398,0.08,2.348,3.098,4674.77,62,82,278.527,355.931
1/1/22,4,24.5,10,11238,1656,6512,0.08,2.66,3.445,4573.82,62.2,82.1,281.904,357.737
2/1/22,3.8,26.3,10.1,11661,1689,6301,0.08,2.9975,3.7625,4435.98,62.2,82.2,287.123,359.627
3/1/22,3.7,24.2,8.8,12134,1380,6014,0.2,3.39,4.172,4391.27,62.3,82.5,294.918,361.083
4/1/22,3.7,24.8,8.6,11881,1386,6002,0.33,4.215,4.9825,4391.3,62.2,82.4,301.537,362.951
5/1/22,3.6,22.4,9,11483,1294,5983,0.77,4.435,5.23,4040.36,62.3,82.6,306.299,365.116
6/1/22,3.6,22.3,8,11256,1355,5951,1.21,4.652,5.522,3898.95,62.2,82.3,308.095,367.927
7/1/22,3.5,22.2,8.3,11610,1120,5768,1.68,4.6125,5.4125,3911.73,62.1,82.3,306.932,370.448
8/1/22,3.6,22.4,8.6,10148,1231,5919,2.33,4.5625,5.2225,4158.56,62.3,82.8,303.51,373.283
9/1/22,3.5,20.2,8.1,10812,1118,5792,2.56,5.35,6.112,3850.52,62.3,82.6,300.346,376.569
10/1/22,3.6,20.8,8,10488,1214,5964,3.08,6.145,6.9,3726.05,62.2,82.6,298.565,379.436
11/1/22,3.6,21.5,8.2,10619,1244,5943,3.78,6.1375,6.805,3917.49,62.1,82.4,296.751,382.562
12/1/22,3.5,19.4,8.2,10876,1073,5766,4.1,5.668,6.364,3912.38,62.3,82.6,294.244,385.649
1/1/23,3.5,20.3,9.7,10393,1087,5747,4.33,5.425,6.2725,3960.66,62.4,82.8,292.739,388.372
2/1/23,3.6,19.3,8.9,9846,1056,5962,4.57,5.415,6.2575,4079.68,62.5,83,293.536,391.141
3/1/23,3.5,19.5,8.4,9572,1061,5839,4.65,5.796,6.544,3968.56,62.6,83.1,297.459,392.91
4/1/23,3.4,20.9,8.8,9992,1079,5751,4.83,5.6625,6.3425,4121.47,62.6,83.3,301.573,394.898
5/1/23,3.6,21.2,9,9310,1142,6089,5.06,5.8075,6.425,4146.17,62.6,83.4,305.439,396.726
6/1/23,3.6,20.7,8.7,9191,1121,5958,5.08,6.088,6.714,4345.37,62.6,83.4,308.398,398.593
7/1/23,3.5,20.6,9,8606,1196,5920,5.12,6.1775,6.84,4508.08,62.6,83.4,310.32,400.21
8/1/23,3.7,20.4,8.8,9287,1369,6284,5.33,6.43,7.072,4426.24,62.8,83.5,311.683,402.247
9/1/23,3.8,21.4,9,9279,1242,6326,5.33,6.5725,7.2,4409.1,62.7,83.5,312.538,404.487
10/1/23,3.9,21.5,8.5,8550,1331,6479,5.33,6.905,7.62,4258.98,62.7,83.4,312.889,406.683
11/1/23,3.7,19.4,8.8,8663,1170,6254,5.33,6.766,7.442,4460.06,62.8,83.4,312.125,408.838
12/1/23,3.8,22.2,9.6,8585,1273,6315,5.33,6.1375,6.815,4685.05,62.5,83.2,310.939,410.606
1/1/24,3.7,20.8,9.6,8468,1272,6149,5.33,5.87,6.6425,4804.49,62.5,83.3,310.809,412.019
2/1/24,3.9,20.9,9.3,8445,1213,6462,5.33,6.102,6.776,5011.96,62.6,83.5,312.736,413.695
3/1/24,3.9,21.6,9.5,8093,1254,6497,5.33,6.175,6.82,5170.57,62.7,83.4,316.919,415.219
4/1/24,3.9,20,8.9,7619,1253,6492,5.33,6.2625,6.9925,5095.46,62.7,83.5,320.85,416.386
5/1/24,4,21.2,9,7901,1348,6635,5.33,6.346,7.06,5235.23,62.6,83.6,323.794,417.772
6/1/24,4.1,20.7,9.8,7412,1533,6849,5.33,6.1875,6.9175,5415.14,62.6,83.7,325.347,418.82
7/1/24,4.2,20.6,9.5,7504,1543,7097,5.33,6.135,6.8475,5542.89,62.7,83.9,325.668,420.577
8/1/24,4.2,21,9.5,7649,1545,7071,5.33,5.682,6.5,5502.17,62.7,83.9,325.111,422.223
9/1/24,4.1,22.6,9.9,7103,1614,6901,5.13,5.2625,6.18,5626,62.8,83.8,332.22,423.824
10/1/24,4.1,22.7,9.7,7131,1663,6988,4.83,5.55,6.32,5816,62.6,83.5,332.409,424.305
11/1/24,4.2,23.3,10,7133,1622,7128,4.58,5.922,6.7025,5939.5,62.5,83.4,332.61,424.931
12/1/24,4.2,22.6,9.8,7192,1542,7236,4.33,6.014,6.878,5983.5,62.5,83.4,332.392,425.466
1/1/25,4.2,23.2,10,7242,1551,7223,4.33,5.9125,6.7725,5903,62.3,83.3,332.417,427.086
2/1/25,4.1,23.1,10.2,7460,1549,7058,4.33,5.882,6.742,5999,62.3,83.3,332.249,429.138
3/1/25,4.1,21.6,9.5,7462,1355,6985,4.33,5.918,6.78,6108.5,62.3,83.4,332.064,430.879
4/1/25,4.2,21.8,9.5,7712,1457,7237,4.33,5.954,6.816,5810.92,62.4,83.4,331.45,433.698
6/1/25,4.1,23,10.1,7357,1647,7015,4.33,5.9525,6.8175,6029.95,62.3,83.5,331.671,434.594
7/1/25,4.2,24.1,10.2,7208,1826,7236,4.33,5.86,6.72,6296.5,62.2,83.4,330.978,435.489
8/1/25,4.3,24.5,9.8,7227,1930,7384,4.33,5.71,6.5875,6408.95,62.3,83.7,329.822,436.981
9/1/25,4.4,24.1,,,,7603,4.22,5.55,6.34,6415,,83.7,328.938,438.212`;

// --- Utility: Date Normalization (Ensures proper chart alignment) ---
const normalizeDate = (dateStr) => {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return dateStr;
  
  if (d.getFullYear() < 1980) {
    d.setFullYear(d.getFullYear() + 100);
  }
  return d.toISOString().split('T')[0];
};

const parseCSV = (csvText) => {
  const lines = csvText.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim());
  return lines.slice(1).map(line => {
    if (!line.trim()) return null;
    const values = line.split(',');
    const entry = {};
    headers.forEach((header, index) => {
      let value = values[index] ? values[index].trim() : "";
      if (header === 'observation_date') {
        entry[header] = normalizeDate(value);
      } else {
        const num = parseFloat(value);
        if ((header === 'unemployed_count' || header === 'Housing Price Index') && num === 0) {
           entry[header] = null;
        } else {
           entry[header] = isNaN(num) ? null : num;
        }
      }
    });
    return entry;
  }).filter(item => item !== null);
};

// --- Advanced Calculation: Philips Curve (Inflation Rate vs Unemployment) ---
const calculatePhilipsData = (data) => {
  return data.map((row, index) => {
    // Need previous year's CPI to calculate inflation
    if (index < 12) return null;
    const prevCPI = data[index - 12]['CPI'];
    const currCPI = row['CPI'];
    if (!prevCPI || !currCPI) return null;
    
    const inflationRate = ((currCPI - prevCPI) / prevCPI) * 100;
    
    return {
      x: row['unemployment_rate'], // X-axis
      y: inflationRate,            // Y-axis
      date: row['observation_date'],
      cpi: currCPI
    };
  }).filter(item => item !== null && item.x != null && item.y != null);
};

// --- Advanced Calculation: Beveridge Curve (Unemployment vs Job Openings Rate) ---
const calculateBeveridgeData = (data) => {
  return data.map(row => {
    if (!row['unemployment_rate'] || !row['job_openings']) return null;
    
    // Convert Job Openings Level to a Rate approximation or normalized value
    // For simplicity, we use level, but typically rate = openings / (employment + openings)
    // Here we stick to level for raw visualization
    return {
      x: row['unemployment_rate'],
      y: row['job_openings'],
      date: row['observation_date']
    };
  }).filter(item => item !== null);
};

// --- Advanced Calculation: Housing Affordability ---
const calculateHousingAffordability = (data) => {
  // Normalize everything to start at 100 for comparison
  const baseHPI = data.find(d => d['Housing Price Index'])?.['Housing Price Index'] || 100;
  const baseSP = data.find(d => d['S&P 500'])?.['S&P 500'] || 100;
  
  return data.map(row => {
    const hpi = row['Housing Price Index'];
    const rate = row['30 year mortgage'];
    const sp = row['S&P 500'];
    
    if (!hpi || !rate) return { ...row, affordability: null, assetPrice: null };

    // Rough "Payment Burden" proxy: Price * Rate (Conceptually, P*r ~ Interest Payment)
    // We index this to start at 100
    const burdenRaw = hpi * rate; 
    
    // Find first valid burden to normalize
    // (This logic ideally runs once outside, but simplified here for the map)
    
    return {
      ...row,
      // Just return raw values for the chart to handle via indexing, 
      // or we can pre-calculate a specialized "Burden Index" here.
      // Let's create a "Monthly Payment Proxy"
      paymentProxy: (hpi * (rate / 100)), // Very simplified P*r
      spIndexed: (sp / baseSP) * 100
    };
  });
};


export default function App() {
  const [data, setData] = useState([]);
  const [selectedKeys, setSelectedKeys] = useState(new Set(["job_openings", "S&P 500"]));
  const [viewMode, setViewMode] = useState("dashboard"); // 'dashboard', 'philips', 'beveridge', 'housing'
  const [loading, setLoading] = useState(false);
  const [chartMode, setChartMode] = useState("absolute");
  const [showSpread, setShowSpread] = useState(false);

  useEffect(() => {
    const parsed = parseCSV(INITIAL_CSV_DATA);
    setData(parsed);
  }, []);

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    setLoading(true);
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = parseCSV(e.target.result);
        setData(parsed);
      } catch (err) {
        console.error("Failed to parse CSV", err);
      } finally {
        setLoading(false);
      }
    };
    reader.readAsText(file);
  };

  const toggleIndicator = (key) => {
    const newSet = new Set(selectedKeys);
    if (newSet.has(key)) {
      if (newSet.size > 1) newSet.delete(key);
    } else {
      newSet.add(key);
    }
    setSelectedKeys(newSet);
  };

  // --- Derived Data for Advanced Views ---
  const philipsData = useMemo(() => calculatePhilipsData(data), [data]);
  const beveridgeData = useMemo(() => calculateBeveridgeData(data), [data]);
  const housingData = useMemo(() => calculateHousingAffordability(data), [data]);

  // --- Main Dashboard Data Logic ---
  const selectedKeysArray = Array.from(selectedKeys);
  const isComparisonEligible = chartMode === "indexed" && selectedKeys.size === 2;

  const processedData = useMemo(() => {
    if (chartMode === "absolute") return data;

    const baselines = {};
    data.forEach(row => {
      selectedKeysArray.forEach(key => {
        const configKey = INDICATOR_CONFIG[key].dataKey;
        if (!baselines[key] && row[configKey] !== null && row[configKey] !== undefined) {
          baselines[key] = row[configKey];
        }
      });
    });

    return data.map(row => {
      const newRow = { ...row };
      
      selectedKeysArray.forEach(key => {
        const configKey = INDICATOR_CONFIG[key].dataKey;
        const val = row[configKey];
        if (val !== null && baselines[key]) {
          newRow[configKey] = (val / baselines[key]) * 100;
        }
      });

      if (isComparisonEligible) {
        const key1 = selectedKeysArray[0];
        const key2 = selectedKeysArray[1];
        const val1 = newRow[INDICATOR_CONFIG[key1].dataKey];
        const val2 = newRow[INDICATOR_CONFIG[key2].dataKey];
        
        if (val1 && val2) {
          newRow.spread = Math.abs(val1 - val2);
        }
      }
      return newRow;
    });
  }, [data, selectedKeys, chartMode, isComparisonEligible]);

  // --- Render Helpers ---
  const renderDashboard = () => (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px] flex flex-col relative">
      <div className="mb-2 flex justify-between items-center z-10">
        <h3 className="text-lg font-semibold text-gray-800">
          {chartMode === "indexed" ? "Relative Performance (Base = 100)" : "Historical Data"}
        </h3>
        {isComparisonEligible && showSpread && (
            <span className="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded flex items-center gap-1">
              <Minus className="w-3 h-3" strokeDasharray="4 4" /> Difference (Spread)
            </span>
        )}
      </div>
      
      <div className="flex-1 w-full min-h-0">
        <ResponsiveContainer width="100%" height="100%">
          <ComposedChart data={processedData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
            <XAxis 
              dataKey="observation_date" 
              tick={{fill: '#9ca3af', fontSize: 12}}
              tickLine={false}
              axisLine={{stroke: '#e5e7eb'}}
              minTickGap={60}
            />
            {chartMode === "indexed" ? (
              <YAxis tick={{fill: '#9ca3af', fontSize: 12}} tickLine={false} axisLine={false} domain={['auto', 'auto']} />
            ) : (
              <>
                <YAxis yAxisId="left" tick={{fill: '#9ca3af', fontSize: 12}} tickLine={false} axisLine={false} orientation="left" />
                <YAxis yAxisId="right" orientation="right" tick={{fill: '#9ca3af', fontSize: 12}} tickLine={false} axisLine={false} />
              </>
            )}
            {REFERENCE_ZONES.map((zone, idx) => (
              <ReferenceArea 
                key={idx}
                x1={zone.start} 
                x2={zone.end} 
                yAxisId={chartMode === "indexed" ? undefined : "left"}
                fill={zone.color} 
                fillOpacity={zone.opacity}
                ifOverflow="extendDomain"
                label={{ value: zone.label, position: zone.labelPos || 'insideTop', fontSize: 10, fill: '#6b7280' }}
              />
            ))}
            <Tooltip 
              contentStyle={{backgroundColor: 'white', borderRadius: '8px', border: '1px solid #e5e7eb', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}}
              itemStyle={{fontSize: '12px'}}
              labelStyle={{fontWeight: 'bold', color: '#374151', marginBottom: '4px'}}
            />
            <Legend wrapperStyle={{paddingTop: '20px'}} />
            {Array.from(selectedKeys).map((key, index) => {
              const config = INDICATOR_CONFIG[key];
              const axisId = (chartMode === "absolute" && index > 0) ? "right" : "left";
              return (
                <Line
                  key={key}
                  yAxisId={chartMode === "indexed" ? undefined : axisId}
                  type="monotone"
                  dataKey={config.dataKey}
                  name={config.label}
                  stroke={config.color}
                  strokeWidth={2.5}
                  dot={false}
                  activeDot={{ r: 6, strokeWidth: 0 }}
                  connectNulls={true}
                  animationDuration={800}
                />
              );
            })}
            {isComparisonEligible && showSpread && (
              <Line type="monotone" dataKey="spread" name="Spread (Diff)" stroke="#4f46e5" strokeWidth={2} strokeDasharray="5 5" dot={false} activeDot={false} opacity={0.6} />
            )}
          </ComposedChart>
        </ResponsiveContainer>
      </div>
    </div>
  );

  const renderPhilipsCurve = () => (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px] flex flex-col">
      <div className="mb-4">
        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
          <Activity className="w-5 h-5 text-purple-600" />
          The Philips Curve (Inflation vs. Unemployment)
        </h3>
        <p className="text-sm text-gray-500">Each point represents a month in history. Theory suggests lower unemployment leads to higher inflation.</p>
      </div>
      <ResponsiveContainer width="100%" height="100%">
        <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis type="number" dataKey="x" name="Unemployment" unit="%" label={{ value: 'Unemployment Rate (%)', position: 'insideBottom', offset: -10 }} />
          <YAxis type="number" dataKey="y" name="Inflation" unit="%" label={{ value: 'Inflation Rate (YoY %)', angle: -90, position: 'insideLeft' }} />
          <ZAxis type="category" dataKey="date" name="Date" />
          <Tooltip cursor={{ strokeDasharray: '3 3' }} />
          <Scatter name="Economic Cycles" data={philipsData} fill="#8884d8" />
        </ScatterChart>
      </ResponsiveContainer>
    </div>
  );

  const renderBeveridgeCurve = () => (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px] flex flex-col">
      <div className="mb-4">
        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
          <Briefcase className="w-5 h-5 text-orange-500" />
          The Beveridge Curve (Job Openings vs. Unemployment)
        </h3>
        <p className="text-sm text-gray-500">Measures labor market efficiency. Outward shifts indicate structural changes (e.g. post-COVID).</p>
      </div>
      <ResponsiveContainer width="100%" height="100%">
        <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis type="number" dataKey="x" name="Unemployment" unit="%" label={{ value: 'Unemployment Rate (%)', position: 'insideBottom', offset: -10 }} />
          <YAxis type="number" dataKey="y" name="Job Openings" unit="" label={{ value: 'Job Openings (Thousands)', angle: -90, position: 'insideLeft' }} />
          <ZAxis type="category" dataKey="date" name="Date" />
          <Tooltip cursor={{ strokeDasharray: '3 3' }} />
          <Scatter name="Labor Market Health" data={beveridgeData} fill="#ff7300" line shape="circle" />
        </ScatterChart>
      </ResponsiveContainer>
    </div>
  );

  const renderHousingAffordability = () => (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px] flex flex-col">
      <div className="mb-4">
        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
          <Home className="w-5 h-5 text-brown-600" />
          Housing Affordability Proxy
        </h3>
        <p className="text-sm text-gray-500">Calculated as (Home Price Index * Mortgage Rate). Higher = Less Affordable.</p>
      </div>
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={housingData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="observation_date" tickFormatter={(str) => str.substring(0, 4)} />
          <YAxis />
          <Tooltip />
          <Legend />
          <Line type="monotone" dataKey="paymentProxy" name="Monthly Payment Burden (Proxy)" stroke="#d62728" strokeWidth={3} dot={false} />
          <Line type="monotone" dataKey="Housing Price Index" name="Home Prices Only" stroke="#8d6e63" strokeWidth={1} dot={false} strokeDasharray="5 5" />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 p-6 font-sans">
      <div className="max-w-6xl mx-auto space-y-6">
        
        {/* Main Header */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
              <Activity className="h-6 w-6 text-blue-600" />
              Economic Indicators Dashboard
            </h1>
            <p className="text-gray-500 text-sm mt-1">
              Explore correlations, inflation curves, and market health.
            </p>
          </div>
          
          <div className="flex gap-3 items-center">
             {/* View Mode Selector */}
             <div className="flex bg-gray-100 p-1 rounded-lg">
                <button onClick={() => setViewMode('dashboard')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'dashboard' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Timeline</button>
                <button onClick={() => setViewMode('philips')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'philips' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}>Philips Curve</button>
                <button onClick={() => setViewMode('beveridge')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'beveridge' ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}>Beveridge</button>
                <button onClick={() => setViewMode('housing')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'housing' ? 'bg-white shadow text-red-600' : 'text-gray-500'}`}>Housing</button>
             </div>

            <div className="relative h-full">
              <input type="file" accept=".csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              <button className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg transition-colors shadow-sm text-sm font-medium h-full">
                <Upload className="h-4 w-4" />
                Upload CSV
              </button>
            </div>
          </div>
        </div>

        {/* View Logic */}
        {viewMode === 'dashboard' && (
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            {/* Sidebar Controls */}
            <div className="lg:col-span-1 space-y-4">
              {/* Chart Mode Toggle */}
              <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                 <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Chart Mode</h3>
                 <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                  <button
                    onClick={() => setChartMode("absolute")}
                    className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded-md text-xs font-medium transition-all ${
                      chartMode === "absolute" ? "bg-white text-blue-600 shadow-sm" : "text-gray-500 hover:text-gray-700"
                    }`}
                  >
                    <BarChart2 className="w-3 h-3" /> Raw
                  </button>
                  <button
                    onClick={() => setChartMode("indexed")}
                    className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded-md text-xs font-medium transition-all ${
                      chartMode === "indexed" ? "bg-white text-blue-600 shadow-sm" : "text-gray-500 hover:text-gray-700"
                    }`}
                  >
                    <TrendingUp className="w-3 h-3" /> Relative
                  </button>
                </div>

                <h2 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">
                  Indicators
                </h2>
                <div className="space-y-1">
                  {Object.keys(INDICATOR_CONFIG).map((key) => {
                    const config = INDICATOR_CONFIG[key];
                    const isSelected = selectedKeys.has(key);
                    return (
                      <button
                        key={key}
                        onClick={() => toggleIndicator(key)}
                        className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all duration-200 border ${
                          isSelected
                            ? "bg-blue-50 border-blue-200 text-blue-800 font-medium"
                            : "bg-transparent border-transparent hover:bg-gray-50 text-gray-600"
                        }`}
                      >
                        {isSelected 
                          ? <CheckSquare className="w-5 h-5 text-blue-600" /> 
                          : <Square className="w-5 h-5 text-gray-300" />}
                        <span className="flex-1 text-left truncate">{config.label}</span>
                      </button>
                    );
                  })}
                </div>
              </div>
              
              {/* Analysis Tools */}
              {isComparisonEligible && (
                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 transition-all duration-500 animate-in fade-in slide-in-from-top-2">
                   <h3 className="font-semibold text-indigo-900 text-sm flex items-center gap-2 mb-2">
                     <ArrowRightLeft className="w-4 h-4" />
                     Spread Analysis
                   </h3>
                   <button
                      onClick={() => setShowSpread(!showSpread)}
                      className={`w-full text-xs flex items-center justify-center gap-2 px-3 py-2 rounded-md font-medium transition-all ${
                        showSpread
                          ? "bg-indigo-600 text-white shadow-sm"
                          : "bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50"
                      }`}
                    >
                      {showSpread ? "Hide Difference" : "Show Difference Line"}
                    </button>
                </div>
              )}
            </div>

            {/* Main Dashboard Chart */}
            <div className="lg:col-span-3 space-y-6">
              {renderDashboard()}
              
              {/* Dynamic Definitions */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {Array.from(selectedKeys).map(key => {
                  const config = INDICATOR_CONFIG[key];
                  return (
                    <div key={key} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-start gap-3">
                      <div className="mt-1 w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: config.color }} />
                      <div>
                        <h4 className="font-semibold text-gray-900">{config.label}</h4>
                        <p className="text-sm text-gray-600 mt-1 mb-2 leading-relaxed">
                          {config.definition}
                        </p>
                        <a 
                          href={config.source} 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="text-xs text-blue-600 hover:underline inline-flex items-center gap-1"
                        >
                          View Source <ExternalLink className="h-3 w-3" />
                        </a>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* Advanced Views */}
        {viewMode === 'philips' && (
          <div className="space-y-6">
            {renderPhilipsCurve()}
            <div className="bg-white p-6 rounded-xl border border-gray-100 text-sm text-gray-600">
              <h4 className="font-bold text-gray-900 mb-2">How to read this chart:</h4>
              <p>The Philips Curve illustrates the inverse trade-off between unemployment and inflation. In a "normal" economy, you would expect points to form a downward sloping curve (like a slide). When dots move to the top-right (High Inflation + High Unemployment), that indicates Stagflation (e.g., 1970s). The recent post-COVID era is often visible as a chaotic loop in the top-left or top-center.</p>
            </div>
          </div>
        )}

        {viewMode === 'beveridge' && (
          <div className="space-y-6">
            {renderBeveridgeCurve()}
            <div className="bg-white p-6 rounded-xl border border-gray-100 text-sm text-gray-600">
              <h4 className="font-bold text-gray-900 mb-2">How to read this chart:</h4>
              <p>The Beveridge Curve shows the relationship between unemployment and job openings. A healthy economy moves up and down a diagonal line. A <strong>shift outward</strong> (up and to the right) indicates a structural mismatchcompanies want to hire, but the available workers don't fit the roles or aren't taking the jobs. This shift is a key feature of the post-2020 economy.</p>
            </div>
          </div>
        )}

        {viewMode === 'housing' && (
          <div className="space-y-6">
            {renderHousingAffordability()}
            <div className="bg-white p-6 rounded-xl border border-gray-100 text-sm text-gray-600">
              <h4 className="font-bold text-gray-900 mb-2">Understanding Affordability:</h4>
              <p>The <strong>Red Line</strong> (Payment Burden) combines price and interest rates. It is a better proxy for "affordability" than price alone. Notice how the red line spikes significantly higher than the brown line (Price) in recent yearsthis gap represents the impact of interest rate hikes on monthly payments, making homes historically unaffordable even if prices settle.</p>
            </div>
          </div>
        )}

      </div>
    </div>
  );
}